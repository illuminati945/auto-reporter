{% extends 'base.html' %}
{% block content %}

<div class="mb-6 flex justify-between items-center">
    <a href="{% url 'dashboard' %}" class="text-slate-400 hover:text-white transition flex items-center">
        <i class="fas fa-arrow-left mr-2"></i> Dashboard
    </a>
    <h1 class="text-2xl font-bold text-white">Submission Report</h1>
</div>

<div class="space-y-8 mb-32"> {% for cal in calendars %}
    <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-xl">
        <div class="bg-slate-900 px-6 py-3 border-b border-slate-700">
            <h2 class="font-bold text-lg text-blue-400">{{ cal.name }} {{ cal.year }}</h2>
        </div>

        <div class="p-4">
            <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-slate-500 uppercase">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>

            {% for week in cal.weeks %}
            <div class="grid grid-cols-7 gap-2 mb-2">
                {% for day in week %}
                {% if day is None %}
                <div class="h-14"></div>
                {% else %}
                {% if day.result %}
                <button onclick="openModal(this.getAttribute('data-report'))"
                    data-report="{{ day.result.json_str|force_escape }}" class="group relative h-14 w-full rounded-lg border flex flex-col items-center justify-center transition hover:scale-105 active:scale-95
                            {% if day.result.success %}
                                bg-green-900/40 border-green-600 text-green-200
                            {% else %}
                                bg-red-900/40 border-red-600 text-red-200
                            {% endif %}">

                    <span class="text-sm font-bold">{{ day.day }}</span>
                    <div class="mt-1">
                        {% if day.result.success %}
                        <i class="fas fa-check-circle text-xs text-green-400"></i>
                        {% else %}
                        <i class="fas fa-times-circle text-xs text-red-400"></i>
                        {% endif %}
                    </div>
                </button>
                {% else %}
                <div class="h-14 rounded-lg border flex flex-col items-center justify-center 
                            bg-slate-700/20 border-slate-700/50 text-slate-500 cursor-default opacity-50">
                    <span class="text-sm">{{ day.day }}</span>
                </div>
                {% endif %}
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<div id="modalOverlay" onclick="closeModal()"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden transition-opacity duration-300 opacity-0"></div>

<div id="resultModal"
    class="fixed bottom-0 left-0 right-0 z-50 bg-slate-900 border-t border-slate-700 rounded-t-2xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out max-h-[85vh] flex flex-col">

    <div class="flex-none p-4 border-b border-slate-800 flex justify-between items-center cursor-pointer"
        onclick="closeModal()">
        <div>
            <h3 class="text-lg font-bold text-white" id="modalTitle">Report Details</h3>
            <p class="text-xs text-slate-400" id="modalDate">Select a date</p>
        </div>
        <button class="bg-slate-800 p-2 rounded-full text-slate-400 hover:text-white transition">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto p-4 font-mono text-sm space-y-4">

        <div id="modalStatus" class="p-3 rounded-lg text-center font-bold border">
        </div>

        <div class="bg-slate-950 p-4 rounded-lg border border-slate-800 overflow-x-auto">
            <h4 class="text-xs uppercase text-slate-500 font-bold mb-2">Full Request & Response Log</h4>
            <div id="jsonContainer" class="json-tree text-slate-300">
            </div>
        </div>
    </div>
</div>

<style>
    /* Styling for the JSON Tree */
    .json-tree details {
        margin-left: 10px;
    }

    .json-tree summary {
        cursor: pointer;
        list-style: none;
        outline: none;
    }

    .json-tree summary::-webkit-details-marker {
        display: none;
    }

    /* Hide default triangle */

    /* Custom Arrow */
    .json-tree summary::before {
        content: 'â–¶';
        display: inline-block;
        font-size: 10px;
        width: 15px;
        color: #64748b;
        transition: transform 0.2s;
    }

    .json-tree details[open]>summary::before {
        transform: rotate(90deg);
    }

    .json-key {
        color: #93c5fd;
    }

    /* Blue-300 */
    .json-string {
        color: #86efac;
    }

    /* Green-300 */
    .json-number {
        color: #fca5a5;
    }

    /* Red-300 */
    .json-boolean {
        color: #fcd34d;
    }

    /* Yellow-300 */
    .json-null {
        color: #94a3b8;
    }

    /* Slate-400 */
</style>

<script>
    const modal = document.getElementById('resultModal');
    const overlay = document.getElementById('modalOverlay');
    const container = document.getElementById('jsonContainer');

    function openModal(jsonString) {
        // 1. Parse Data
        const data = JSON.parse(jsonString);

        // 2. Populate Header & Status
        document.getElementById('modalTitle').innerText = "Attendance Report";
        document.getElementById('modalDate').innerText = data.date;

        const statusDiv = document.getElementById('modalStatus');
        if (data.success) {
            statusDiv.className = "p-3 rounded-lg text-center font-bold border bg-green-900/30 border-green-600 text-green-400";
            statusDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Submission Successful`;
        } else {
            statusDiv.className = "p-3 rounded-lg text-center font-bold border bg-red-900/30 border-red-600 text-red-400";
            statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ${data.message}`;
        }

        // 3. Render Recursive JSON
        container.innerHTML = createJsonTree(data);

        // 4. Show Modal (Slide Up)
        overlay.classList.remove('hidden');
        // Small timeout to allow removing 'hidden' to render, then animate opacity
        requestAnimationFrame(() => {
            overlay.classList.remove('opacity-0');
            modal.classList.remove('translate-y-full');
        });
    }

    function closeModal() {
        modal.classList.add('translate-y-full');
        overlay.classList.add('opacity-0');

        // Wait for animation to finish before hiding display
        setTimeout(() => {
            overlay.classList.add('hidden');
        }, 300);
    }

    // --- RECURSIVE JSON RENDERER ---
    function createJsonTree(obj) {
        if (obj === null) return '<span class="json-null">null</span>';
        if (typeof obj === 'boolean') return `<span class="json-boolean">${obj}</span>`;
        if (typeof obj === 'number') return `<span class="json-number">${obj}</span>`;
        if (typeof obj === 'string') return `<span class="json-string">"${obj}"</span>`;

        // It's an Object or Array
        const isArray = Array.isArray(obj);
        let html = '';

        // Start Details
        html += `<details open>`; // Default open

        // Summary (The clickable part)
        html += `<summary>`;
        html += isArray ? `Array [${obj.length}]` : `Object {${Object.keys(obj).length}}`;
        html += `</summary>`;

        // Children
        html += `<div class="ml-2 pl-2 border-l border-slate-700">`;
        for (const key in obj) {
            html += `<div>`;
            html += `<span class="json-key">${key}:</span> `;
            html += createJsonTree(obj[key]);
            html += `</div>`;
        }
        html += `</div>`;
        html += `</details>`;

        return html;
    }
</script>


<!-- 2. AUTO-HEAL TOAST NOTIFICATION -->
{% if cookie_updated %}

<div id="cookieToast" onclick="dismissToast()"
    class="fixed top-0 left-1/2 transform -translate-x-1/2 -translate-y-full opacity-0 z-50 mt-2 transition-all duration-700 cubic-bezier(0.16, 1, 0.3, 1) cursor-pointer w-[90%] max-w-sm sm:w-auto">
    <div
        class="bg-slate-800 border border-green-500/50 rounded-2xl shadow-2xl px-4 py-3 flex items-center space-x-3 backdrop-blur-md bg-opacity-95">
        <div class="w-8 h-8 bg-green-900/50 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-magic text-sm text-green-400"></i>
        </div>
        <div class="flex flex-col min-w-0">
            <h3 class="font-bold text-white text-sm truncate">Session Auto-Healed</h3>
            <p class="text-slate-400 text-xs truncate">Security keys rotated & saved</p>
        </div>
    </div>
</div>
<script>
    function dismissToast() {
        const toast = document.getElementById('cookieToast');
        if (toast) {
            toast.classList.add('-translate-y-full');
            toast.classList.add('opacity-0');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const toast = document.getElementById('cookieToast');
        if (toast) {
            // Force browser reflow
            void toast.offsetWidth;

            // Slide Down & Fade In
            requestAnimationFrame(() => {
                toast.classList.remove('-translate-y-full');
                toast.classList.remove('opacity-0');
            });

            // Slide Up & Fade Out automatically
            setTimeout(() => {
                dismissToast();
            }, 8000);
        }
    });
</script>
{% endif %}


{% endblock %}